version: "3.9"
services:
  db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: raido
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: raido
    volumes: [db:/var/lib/postgresql/data]

  db-admin:
    image: dpage/pgadmin4:latest
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@raido.local
      PGADMIN_DEFAULT_PASSWORD: ${POSTGRES_PASSWORD}
    ports: ["5050:80"]
    depends_on: [db]

  icecast:
    image: infiniteproject/icecast
    restart: unless-stopped
    ports: ["8000:8000"]
    environment:
      - ICECAST_SOURCE_PASSWORD=hackme
      - ICECAST_ADMIN_PASSWORD=hackme
      - ICECAST_PASSWORD=hackme
      - ICECAST_RELAY_PASSWORD=hackme
    volumes:
      - ./logs/icecast:/var/log/icecast

  liquidsoap:
    image: savonet/liquidsoap:v2.2.5
    restart: unless-stopped
    depends_on: [icecast]
    volumes:
      - /mnt/music:/mnt/music:ro
      - ./infra/liquidsoap/radio.liq:/radio.liq:ro
      - shared:/shared
    command: ["liquidsoap","/radio.liq"]
    ports: ["1234:1234","8080:8080"]

  api:
    build: ./services/api
    restart: unless-stopped
    env_file: .env
    depends_on: [db]
    volumes: 
      - shared:/shared
      - /mnt/music:/mnt/music:ro

  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    volumes: 
      - ollama:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0:11434

  dj-worker:
    build: ./services/dj-worker
    restart: unless-stopped
    env_file: .env
    depends_on: [api, ollama]
    volumes: [shared:/shared]

  proxy:
    image: caddy:2
    restart: unless-stopped
    ports: ["80:80","443:443"]
    volumes:
      - ./infra/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy:/data
      - shared:/shared
    depends_on: [api, icecast]

  web:
    build: ./web
    restart: unless-stopped
    environment: { VITE_API_URL: "https://{{your-domain}}" }
    depends_on: [api]

volumes: { db: {}, caddy: {}, shared: {}, ollama: {} }
