version: '3.8'
services:
  main-liquidsoap:
    image: savonet/liquidsoap:v2.2.5
    restart: unless-stopped
    depends_on:
    - icecast
    volumes:
    - /mnt/music:/mnt/music:ro
    - ./infra/liquidsoap/radio.liq:/main.liq:ro
    - shared:/shared
    command:
    - liquidsoap
    - /main.liq
    ports:
    - 1234:1234
    - 8080:8080
  main-dj-worker:
    build: ./services/dj-worker
    restart: unless-stopped
    env_file: .env
    depends_on:
      api:
        condition: service_healthy
    volumes:
    - shared:/shared
    environment:
    - STATION_NAME=main
    - LIQUIDSOAP_HOST=main-liquidsoap
    - LIQUIDSOAP_PORT=1234
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://api:8000/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    mem_limit: 1g
    cpus: '0.50'
  web:
    build: ./web
    restart: unless-stopped
    depends_on:
    - api
  christmas-liquidsoap:
    image: savonet/liquidsoap:v2.2.5
    restart: unless-stopped
    depends_on:
    - icecast
    volumes:
    - /mnt/music:/mnt/music:ro
    - ./infra/liquidsoap/christmas.liq:/christmas.liq:ro
    - shared:/shared
    command:
    - liquidsoap
    - /christmas.liq
    ports:
    - 1235:1235
  christmas-dj-worker:
    build: ./services/dj-worker
    restart: unless-stopped
    env_file: .env
    depends_on:
      api:
        condition: service_healthy
    volumes:
    - shared:/shared
    environment:
    - STATION_NAME=christmas
    - LIQUIDSOAP_HOST=christmas-liquidsoap
    - LIQUIDSOAP_PORT=1235
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://api:8000/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    mem_limit: 1g
    cpus: '0.50'
  christmas-web:
    build: ./web-christmas
    restart: unless-stopped
    depends_on:
    - api
    ports:
    - 9000:80
