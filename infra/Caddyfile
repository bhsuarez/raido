{
	# Global options
	admin off
	local_certs
	auto_https off
}

# Domain configuration
raido.zorro.network {
	# Christmas station routes (handle before catch-all)
	redir /christmas /christmas/ 301
	handle /christmas/* {
		reverse_proxy christmas-web:80
	}

	# Redirect legacy DJ admin path
	@legacy_tts path /tts
	@legacy_tts_sub path /tts/*
	redir @legacy_tts /raido/admin 301
	redir @legacy_tts_sub /raido/admin 301

	# Redirect homepage to now playing
	@root path /
	redir @root /now-playing 301

	# API endpoints (specific routes first)
	handle /api/* {
		reverse_proxy api:8000
	}

	# Static files (TTS audio)
	handle /static/* {
		reverse_proxy api:8000
	}

	# WebSocket endpoint
	handle /ws {
		reverse_proxy api:8000 {
			header_up Upgrade {http.request.header.Upgrade}
			header_up Connection {http.request.header.Connection}
		}
	}

	# Icecast stream
	handle_path /stream/* {
		reverse_proxy icecast:8000
	}

	# Liquidsoap metadata
	handle /liquidsoap/* {
		reverse_proxy liquidsoap:8080
	}

	# Health check
	handle /health {
		respond "OK" 200
	}

	# Finally, serve React frontend (catch-all)
	handle /* {
		reverse_proxy web:80
	}

	# Security headers
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}

	# Enable CORS for development
	header /api/* {
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Authorization"
	}
	
	# CORS for static files
	header /static/* {
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, OPTIONS"
		Access-Control-Allow-Headers "Content-Type"
	}

	# Handle preflight requests
	@cors_preflight method OPTIONS path /api/*
	respond @cors_preflight 204

	# Logging
	log {
		output file /var/log/caddy/access.log
		format json
	}
}

# Christmas frontend on subdomain and port 8888
christmas.raido.zorro.network, raido.zorro.network:8888, :8888 {
	# API endpoints (needed for artwork lookup and DJ admin)
	handle /api/* {
		reverse_proxy api:8000
	}

	# Static files (TTS audio)
	handle /static/* {
		reverse_proxy api:8000
	}

	# WebSocket endpoint
	handle /ws {
		reverse_proxy api:8000 {
			header_up Upgrade {http.request.header.Upgrade}
			header_up Connection {http.request.header.Connection}
		}
	}

	# Icecast stream (needed for metadata and artwork)
	handle_path /stream/* {
		reverse_proxy icecast:8000
	}

	# Enable CORS for API
	header /api/* {
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Authorization"
	}

	# Handle preflight requests
	@cors_preflight method OPTIONS path /api/*
	respond @cors_preflight 204

	# Finally, serve Christmas frontend (catch-all)
	handle /* {
		reverse_proxy christmas-web:80
	}
}

# Main site (localhost/IP)
:80 {
	# Christmas path route (handle before other routes)
	redir /christmas /christmas/ 301
	handle /christmas/* {
		reverse_proxy christmas-web:80
	}

	# Redirect homepage to stations directory
	@root_local path /
	redir @root_local /stations 301

	# Redirect legacy DJ admin path
	@legacy_tts_local path /tts
	@legacy_tts_local_sub path /tts/*
	redir @legacy_tts_local /raido/admin 301
	redir @legacy_tts_local_sub /raido/admin 301

	# Christmas subdomain (handle first before catch-all)
	@christmas host christmas.raido.local
	handle @christmas {
		reverse_proxy christmas-web:80
	}

	# API endpoints (specific routes first)
	handle /api/* {
		reverse_proxy api:8000
	}

	# Static files (TTS audio)
	handle /static/* {
		reverse_proxy api:8000
	}

	# WebSocket endpoint
	handle /ws {
		reverse_proxy api:8000 {
			header_up Upgrade {http.request.header.Upgrade}
			header_up Connection {http.request.header.Connection}
		}
	}

	# Icecast stream
	handle_path /stream/* {
		reverse_proxy icecast:8000
	}

	# Liquidsoap metadata
	handle /liquidsoap/* {
		reverse_proxy liquidsoap:8080
	}

	# Health check
	handle /health {
		respond "OK" 200
	}

	# Finally, serve React frontend (catch-all)
	handle /* {
		reverse_proxy web:80
	}

	# Security headers
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		# Remove server identification
		-Server
	}

	# Enable CORS for development
	header /api/* {
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Authorization"
	}
	
	# CORS for static files
	header /static/* {
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, OPTIONS"
		Access-Control-Allow-Headers "Content-Type"
	}

	# Handle preflight requests
	@cors_preflight method OPTIONS path /api/*
	respond @cors_preflight 204

	# Logging
	log {
		output file /var/log/caddy/access.log
		format json
	}
}
